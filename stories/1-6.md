````markdown
# Story 1.6: Test Lab Setup

**Epic:** 1 - Infrastructure Enhancement
**Status:** ❌ TODO

## Description
Build a comprehensive hardware test lab that simulates a complete Guard-e-loo site deployment using repurposed laptops and camera equipment. Provides isolated environment for testing ESP32-CAM firmware, Pi gateway integration, motion detection, encryption, and multi-device coordination before field deployment. Essential for validating all system components in realistic conditions.

## Goals
- Simulated site environment with multiple devices
- Safe testing without affecting production
- Cost-effective using repurposed hardware
- Full stack testing (ESP32 → Pi → EC2)
- Network isolation from production
- Reproducible test scenarios
- Hardware debugging capabilities
- Performance benchmarking baseline
- Training environment for new features

## Hardware Requirements

### Minimum Test Lab Configuration

**Devices:**
- **2 Laptops** (repurposed old laptops or Raspberry Pi alternatives)
  - Laptop 1: Pi Gateway simulator (Ubuntu 22.04)
  - Laptop 2: EC2 simulator / monitoring station
- **1 ESP32-CAM module** (AI-Thinker)
- **1 USB webcam** (for Pi motion detection testing)
- **WiFi Router** (TP-Link or similar, isolated network)
- **USB-to-Serial adapter** (FTDI for ESP32 programming)
- **Power supplies** (5V USB for ESP32, laptop chargers)
- **Ethernet cables** (optional, for wired Pi gateway)

**Optional Enhancements:**
- Additional ESP32-CAM units (2-3 total for multi-device testing)
- PIR sensors (HC-SR501) for occupancy detection testing
- LED strips (simulate flash LED conditions)
- Portable display (HDMI monitor for debugging)

### Recommended Laptop Specifications

**Laptop 1 (Pi Gateway Simulator):**
- CPU: Intel Core i3 or better (2+ cores)
- RAM: 4GB minimum
- Storage: 64GB SSD
- OS: Ubuntu 22.04 LTS (or Raspberry Pi OS on actual Pi 4)
- WiFi: 802.11n or better
- USB: 2+ ports for webcam and serial

**Laptop 2 (EC2 Simulator / Monitoring):**
- CPU: Intel Core i3 or better
- RAM: 4GB minimum
- Storage: 64GB
- OS: Ubuntu 22.04 LTS
- Network: Ethernet + WiFi (for routing)

## Test Lab Network Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Test Lab Network                             │
│                  (192.168.100.0/24)                             │
│                                                                  │
│  ┌──────────────────┐                                           │
│  │  WiFi Router     │                                           │
│  │  192.168.100.1   │                                           │
│  │  SSID: GuardELoo │                                           │
│  │       -TestLab   │                                           │
│  └────┬─────────────┘                                           │
│       │                                                          │
│  ┌────┴───────────────────┬─────────────────┬─────────────────┐│
│  │                        │                 │                  ││
│  │                        │                 │                  ││
│ ┌▼────────────┐  ┌────────▼──────┐  ┌──────▼─────────┐       ││
│ │ Laptop 1    │  │ Laptop 2      │  │ ESP32-CAM #1   │       ││
│ │ Pi Gateway  │  │ EC2 Simulator │  │ 192.168.100.50 │       ││
│ │ .100        │  │ 192.168.100.10│  └────────────────┘       ││
│ │             │  │               │                            ││
│ │ - Pi code   │  │ - Firmware    │  ┌──────────────┐         ││
│ │ - OTA server│  │   repo        │  │ ESP32-CAM #2 │         ││
│ │ - Motion det│  │ - Monitoring  │  │ .100.51      │         ││
│ │ - USB webcam│  │ - Ansible     │  └──────────────┘         ││
│ └─────────────┘  └───────────────┘                            ││
│                                                                 ││
└─────────────────────────────────────────────────────────────────┘
                           │
                           │ (Optional: bridge to internet)
                           ▼
                   Real Internet / EC2
```

## Physical Lab Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                     Test Bench / Desk                           │
│                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌────────────┐      │
│  │  Laptop 1    │     │  Laptop 2    │     │ Power      │      │
│  │  (Pi Gateway)│     │  (EC2/Monitor)     │ Strip      │      │
│  │              │     │              │     └────────────┘      │
│  │  [USB Webcam]│     │              │                         │
│  └──────────────┘     └──────────────┘                         │
│                                                                  │
│  ┌────────────────────────────────────────┐                    │
│  │         WiFi Router                    │                    │
│  │  (center of test area)                 │                    │
│  └────────────────────────────────────────┘                    │
│                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐   │
│  │ ESP32-CAM #1 │     │ ESP32-CAM #2 │     │ PIR Sensor   │   │
│  │ (on stand)   │     │ (on stand)   │     │ (on stand)   │   │
│  │              │     │              │     │              │   │
│  └──────────────┘     └──────────────┘     └──────────────┘   │
│                                                                  │
│  ┌────────────────────────────────────────┐                    │
│  │  Test Target Area                      │                    │
│  │  (simulate toilet entrance)            │                    │
│  │  - Motion targets                       │                    │
│  │  - Lighting conditions                  │                    │
│  └────────────────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
```

## Lab Setup Procedure

### Phase 1: Network Setup

**File: `test_lab/setup/network_config.sh`**
```bash
#!/bin/bash
# Configure test lab network

# WiFi Router Configuration
ROUTER_IP="192.168.100.1"
ROUTER_SSID="GuardELoo-TestLab"
ROUTER_PASSWORD="testlab_secure_password"
DHCP_RANGE="192.168.100.50-192.168.100.150"

echo "Test Lab Network Setup"
echo "======================"
echo "Router IP: $ROUTER_IP"
echo "SSID: $ROUTER_SSID"
echo "Password: $ROUTER_PASSWORD"
echo ""
echo "Manual router configuration steps:"
echo "1. Connect to router via Ethernet"
echo "2. Access http://$ROUTER_IP"
echo "3. Set WiFi SSID: $ROUTER_SSID"
echo "4. Set WiFi password: $ROUTER_PASSWORD"
echo "5. Configure DHCP range: $DHCP_RANGE"
echo "6. Disable WAN access (optional, for isolation)"
echo "7. Enable WiFi isolation between clients (optional)"
```

**Static IP Assignments:**
```bash
# /etc/netplan/01-testlab.yaml (Laptop 1 - Pi Gateway)
network:
  version: 2
  ethernets:
    wlan0:
      dhcp4: no
      addresses:
        - 192.168.100.100/24
      gateway4: 192.168.100.1
      nameservers:
        addresses: [8.8.8.8, 1.1.1.1]
      access-points:
        "GuardELoo-TestLab":
          password: "testlab_secure_password"
```

### Phase 2: Laptop 1 (Pi Gateway Simulator) Setup

**File: `test_lab/setup/setup_laptop1_pi_gateway.sh`**
```bash
#!/bin/bash
# Setup Laptop 1 as Pi Gateway simulator

echo "Setting up Laptop 1 as Pi Gateway..."

# Update system
sudo apt update && sudo apt upgrade -y

# Install Pi dependencies
sudo apt install -y \
    python3 \
    python3-pip \
    python3-opencv \
    python3-numpy \
    git \
    docker.io \
    docker-compose

# Clone Guard-e-loo repository
cd ~
git clone https://github.com/WeeDom/toilet.git
cd toilet/pi1

# Install Python requirements
pip3 install -r requirements.txt

# Setup OTA server
cd ~/toilet/pi_gateway/ota
python3 ota_server.py &

# Create systemd service for Pi gateway
sudo tee /etc/systemd/system/testlab-pi-gateway.service > /dev/null <<EOF
[Unit]
Description=Test Lab Pi Gateway
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=/home/$USER/toilet/pi1
ExecStart=/usr/bin/python3 main.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable testlab-pi-gateway
sudo systemctl start testlab-pi-gateway

echo "Laptop 1 setup complete!"
echo "Pi Gateway running at 192.168.100.100"
```

### Phase 3: Laptop 2 (EC2 Simulator) Setup

**File: `test_lab/setup/setup_laptop2_ec2_simulator.sh`**
```bash
#!/bin/bash
# Setup Laptop 2 as EC2 simulator

echo "Setting up Laptop 2 as EC2 simulator..."

# Install monitoring tools
sudo apt update
sudo apt install -y \
    python3 \
    python3-pip \
    git \
    ansible \
    wireshark \
    tcpdump \
    iftop \
    htop \
    screen

# Clone repository
cd ~
git clone https://github.com/WeeDom/toilet.git

# Setup firmware repository
mkdir -p ~/firmware_repo
cd ~/toilet/esp32cam/CameraWebServer
arduino-cli compile --fqbn esp32:esp32:esp32cam

# Copy firmware to repo
cp build/esp32.esp32.esp32cam/CameraWebServer.ino.bin ~/firmware_repo/v0.1.0.bin

# Start firmware CNC server
cd ~/toilet/ec2/firmware_cnc
pip3 install flask ansible
python3 server.py &

# Setup monitoring dashboard
cd ~/toilet/test_lab/monitoring
python3 -m http.server 8080 &

echo "Laptop 2 setup complete!"
echo "Firmware CNC: http://192.168.100.10:5000"
echo "Monitoring: http://192.168.100.10:8080"
```

### Phase 4: ESP32-CAM Configuration

**File: `test_lab/setup/esp32_testlab_config.h`**
```cpp
// Test lab WiFi configuration
#define TESTLAB_SSID "GuardELoo-TestLab"
#define TESTLAB_PASSWORD "testlab_secure_password"
#define PI_GATEWAY_IP "192.168.100.100"
#define OTA_SERVER "http://192.168.100.100:8888"

// Test lab device IDs
#define DEVICE_ID "TESTLAB-ESP32-001"
#define SITE_ID "testlab"

// Debug mode
#define DEBUG_MODE 1
#define SERIAL_DEBUG 1
```

**Programming Script:**
```bash
#!/bin/bash
# Flash ESP32-CAM with test lab firmware

DEVICE_PORT="/dev/ttyUSB0"
FIRMWARE="CameraWebServer.ino.bin"

echo "Flashing ESP32-CAM with test lab firmware..."
echo "1. Connect GPIO0 to GND"
echo "2. Press reset button"
echo "3. Press Enter to continue"
read

esptool.py --chip esp32 --port $DEVICE_PORT erase_flash
esptool.py --chip esp32 --port $DEVICE_PORT \
    --baud 460800 write_flash -z 0x1000 $FIRMWARE

echo "Flashing complete!"
echo "4. Disconnect GPIO0 from GND"
echo "5. Press reset button"
```

## Test Scenarios

### Test 1: Basic Connectivity

**File: `test_lab/tests/test_01_connectivity.py`**
```python
import requests
import time

def test_pi_gateway_online():
    """Test Pi gateway is accessible"""
    response = requests.get("http://192.168.100.100:5000/api/status")
    assert response.status_code == 200
    print("✓ Pi gateway online")

def test_esp32_camera_stream():
    """Test ESP32 camera stream accessible"""
    response = requests.get("http://192.168.100.50:80", timeout=5)
    assert response.status_code == 200
    print("✓ ESP32-CAM streaming")

def test_ota_server():
    """Test OTA server serving firmware"""
    response = requests.get("http://192.168.100.100:8888/version")
    assert response.status_code == 200
    print("✓ OTA server operational")

if __name__ == '__main__':
    test_pi_gateway_online()
    test_esp32_camera_stream()
    test_ota_server()
    print("\n✓ All connectivity tests passed!")
```

### Test 2: Motion Detection

**File: `test_lab/tests/test_02_motion_detection.py`**
```python
import cv2
import numpy as np
import time

def test_motion_detection_webcam():
    """Test motion detection on USB webcam"""
    cap = cv2.VideoCapture(0)

    print("Testing motion detection (wave hand in front of camera)...")

    ret, frame1 = cap.read()
    ret, frame2 = cap.read()

    motion_detected = False
    timeout = time.time() + 30  # 30 second timeout

    while time.time() < timeout:
        diff = cv2.absdiff(frame1, frame2)
        gray = cv2.cvtColor(diff, cv2.COLOR_BGR2GRAY)
        blur = cv2.GaussianBlur(gray, (5, 5), 0)
        _, thresh = cv2.threshold(blur, 20, 255, cv2.THRESH_BINARY)

        motion_score = np.sum(thresh) / 255

        if motion_score > 1000:
            print(f"✓ Motion detected! Score: {motion_score}")
            motion_detected = True
            break

        frame1 = frame2
        ret, frame2 = cap.read()
        time.sleep(0.1)

    cap.release()

    assert motion_detected, "No motion detected within timeout"
    print("✓ Motion detection working")

if __name__ == '__main__':
    test_motion_detection_webcam()
```

### Test 3: OTA Update

**File: `test_lab/tests/test_03_ota_update.py`**
```python
import requests
import time

def test_ota_update_esp32():
    """Test OTA firmware update on ESP32"""

    # Get current version
    info = requests.get("http://192.168.100.50/api/device/info").json()
    current_version = info['firmware_version']
    print(f"Current firmware: {current_version}")

    # Trigger OTA update
    print("Triggering OTA update...")
    response = requests.post("http://192.168.100.50/api/ota/update", timeout=120)
    assert response.status_code == 200

    # Wait for reboot
    print("Waiting for device reboot...")
    time.sleep(30)

    # Verify new version
    for attempt in range(10):
        try:
            info = requests.get("http://192.168.100.50/api/device/info", timeout=5).json()
            new_version = info['firmware_version']

            if new_version != current_version:
                print(f"✓ OTA update successful! New version: {new_version}")
                return
        except:
            time.sleep(5)

    raise Exception("OTA update failed - device did not come back online")

if __name__ == '__main__':
    test_ota_update_esp32()
```

### Test 4: Multi-Device Coordination

**File: `test_lab/tests/test_04_multi_device.py`**
```python
import requests
import time

DEVICES = [
    "http://192.168.100.50",
    "http://192.168.100.51"
]

def test_all_devices_online():
    """Verify all test devices are online"""
    for device in DEVICES:
        response = requests.get(f"{device}/api/device/info", timeout=5)
        assert response.status_code == 200
        print(f"✓ Device online: {device}")

def test_synchronized_capture():
    """Test simultaneous image capture from multiple devices"""
    print("Testing synchronized capture...")

    captures = []
    for device in DEVICES:
        response = requests.get(f"{device}/capture")
        captures.append(response.content)
        print(f"✓ Captured from {device}: {len(response.content)} bytes")

    assert len(captures) == len(DEVICES)
    print(f"✓ Synchronized capture successful from {len(DEVICES)} devices")

if __name__ == '__main__':
    test_all_devices_online()
    test_synchronized_capture()
```

## Test Lab Documentation

**File: `test_lab/README.md`**
```markdown
# Guard-e-loo Test Lab

## Quick Start

1. **Power on all devices**
2. **Verify network**: `ping 192.168.100.100`
3. **Run connectivity tests**: `python3 tests/test_01_connectivity.py`
4. **Access monitoring**: http://192.168.100.10:8080

## Device IPs

- WiFi Router: 192.168.100.1
- Laptop 1 (Pi Gateway): 192.168.100.100
- Laptop 2 (EC2 Sim): 192.168.100.10
- ESP32-CAM #1: 192.168.100.50
- ESP32-CAM #2: 192.168.100.51

## Common Commands

```bash
# Check Pi gateway logs
ssh testlab@192.168.100.100
journalctl -u testlab-pi-gateway -f

# Flash ESP32
./setup/flash_esp32.sh

# Run all tests
./tests/run_all_tests.sh

# Monitor network traffic
sudo tcpdump -i wlan0 host 192.168.100.50
```

## Troubleshooting

- **ESP32 won't connect**: Check WiFi credentials, reboot router
- **Motion detection not working**: Verify webcam with `cheese` or `v4l2-ctl`
- **OTA fails**: Check OTA server logs, verify firmware binary exists
```

## Acceptance Criteria

- [ ] **Network Isolation**: Test lab on separate 192.168.100.0/24 network
- [ ] **Pi Gateway Simulator**: Laptop 1 running Pi code successfully
- [ ] **EC2 Simulator**: Laptop 2 running firmware CNC and monitoring
- [ ] **ESP32 Programming**: Can flash firmware via USB-to-serial
- [ ] **WiFi Connectivity**: All devices connect to test lab WiFi
- [ ] **Camera Streaming**: ESP32-CAM streams video reliably
- [ ] **Motion Detection**: USB webcam detects motion on Pi simulator
- [ ] **OTA Updates**: Can update ESP32 firmware over WiFi
- [ ] **Multi-Device**: 2+ ESP32-CAM units working simultaneously
- [ ] **Test Automation**: Python test scripts verify all functions
- [ ] **Documentation**: Complete setup and usage guide
- [ ] **Reproducible**: New team member can set up lab from docs
- [ ] **Hardware Labeled**: All devices clearly labeled with IPs/roles
- [ ] **Portable**: Lab can be set up/torn down quickly
- [ ] **Cost**: Total cost under £200 (using repurposed hardware)

## Dependencies
- Story 1.3 (ESP32 firmware) - code to test
- Story 1.5 (OTA infrastructure) - OTA to test
- Repurposed laptops or Raspberry Pi 4 units
- WiFi router
- ESP32-CAM modules

## Notes

- Test lab should remain isolated from production
- Use different WiFi SSID to avoid confusion
- Label all cables and devices clearly
- Keep test lab power strip easily accessible (for full resets)
- Consider portable case for test lab (e.g., toolbox or Pelican case)
- Document all device MAC addresses for troubleshooting
- Take photos of working setup for reference
- Consider live-streaming test lab for remote debugging
- Test lab doubles as demonstration unit for investors/councils

````
