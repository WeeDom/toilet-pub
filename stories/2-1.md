# Story 2.1: PIR WiFi Sensor Nodes

**Epic:** 2 - Smart Privacy Detection
**Status:** ❌ TODO

## Description
Design and build low-cost, battery-powered PIR (Passive Infrared) sensor nodes using ESP8266 microcontrollers to detect occupancy in toilet stalls. These sensors provide privacy-first detection by monitoring human presence without capturing any images, triggering camera disablement when stalls are occupied.

## Goals
- Create affordable sensor nodes (target: £5 per unit)
- Achieve long battery life (target: 3-6 months on single 18650 cell)
- Implement reliable WiFi communication with Pi gateway
- Enable easy installation without wiring requirements
- Support multiple sensors per facility for full coverage
- Provide real-time occupancy status to Pi controller

## Technical Implementation

### Hardware Components

**Microcontroller: ESP8266**
- Wemos D1 Mini or NodeMCU board (£2-3)
- 80MHz CPU, 80KB RAM, 4MB flash
- Built-in WiFi 802.11 b/g/n
- Deep sleep mode: 20µA current draw
- 3.3V operation

**PIR Sensor: HC-SR501 or AM312**
- HC-SR501: Adjustable range (3-7m), sensitivity, delay (£1-2)
- AM312: Mini version, fixed 3m range, lower power (£1)
- 3.3V compatible (or use voltage divider)
- Digital output (HIGH when motion detected)

**Power System:**
- 18650 Li-ion battery (3.7V, 2500-3400mAh) (£2-3)
- TP4056 charging module with protection (£0.50)
- Boost converter to 3.3V (optional, ESP8266 works 3.0-3.6V)
- USB charging port for easy recharge

**Enclosure:**
- 3D printed case or off-the-shelf project box
- Mounting brackets for wall/door installation
- PIR sensor window (transparent to infrared)
- Status LED (optional, low power)

### Circuit Design
```
[18650 Battery] → [TP4056 Protection] → [ESP8266 D1 Mini]
                                              ↓
                                         [GPIO D2] → [PIR Sensor Signal]
                                         [3.3V]   → [PIR VCC]
                                         [GND]    → [PIR GND]
                                         [GPIO D4] → [Status LED + Resistor] → [GND]
```

### Firmware Implementation

**File: `esp8266_pir/pir_sensor.ino`**

```cpp
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>

// Configuration
#define PIR_PIN D2
#define LED_PIN D4
#define DEVICE_ID "PIR-001"
#define PI_GATEWAY "http://192.168.1.100:5000"
#define WIFI_SSID "GuardELoo-Site1"
#define WIFI_PASSWORD "secure_password_here"

// Sleep configuration
#define SLEEP_DURATION_SECONDS 60  // Check every 60 seconds
#define MOTION_REPORT_INTERVAL 5   // Report every 5 seconds when occupied

// State
bool lastMotionState = false;
unsigned long lastReportTime = 0;

void setup() {
  Serial.begin(115200);
  pinMode(PIR_PIN, INPUT);
  pinMode(LED_PIN, OUTPUT);

  // Connect to WiFi
  connectWiFi();

  // Register device with Pi
  registerDevice();
}

void loop() {
  bool motionDetected = digitalRead(PIR_PIN);
  unsigned long now = millis();

  if (motionDetected) {
    // Occupied - report frequently
    if (now - lastReportTime > MOTION_REPORT_INTERVAL * 1000) {
      reportOccupancy(true);
      lastReportTime = now;
    }
    lastMotionState = true;
    delay(5000); // Stay awake while occupied
  } else {
    // Not occupied
    if (lastMotionState) {
      // State change - report immediately
      reportOccupancy(false);
      lastMotionState = false;
    }
    // Enter deep sleep to save battery
    goToSleep();
  }
}

void connectWiFi() {
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    digitalWrite(LED_PIN, !digitalRead(LED_PIN)); // Blink
    attempts++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    digitalWrite(LED_PIN, LOW); // LED off when connected
    Serial.println("WiFi connected: " + WiFi.localIP().toString());
  }
}

void registerDevice() {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  WiFiClient client;

  String url = String(PI_GATEWAY) + "/api/devices/register";
  http.begin(client, url);
  http.addHeader("Content-Type", "application/json");

  String payload = "{\"device_id\":\"" + String(DEVICE_ID) +
                   "\",\"type\":\"pir_sensor\"," +
                   "\"mac\":\"" + WiFi.macAddress() + "\"}";

  int httpCode = http.POST(payload);
  if (httpCode > 0) {
    Serial.println("Registered: " + http.getString());
  }
  http.end();
}

void reportOccupancy(bool occupied) {
  if (WiFi.status() != WL_CONNECTED) {
    connectWiFi();
  }

  HTTPClient http;
  WiFiClient client;

  String url = String(PI_GATEWAY) + "/api/occupancy/report";
  http.begin(client, url);
  http.addHeader("Content-Type", "application/json");

  String payload = "{\"device_id\":\"" + String(DEVICE_ID) +
                   "\",\"occupied\":" + String(occupied ? "true" : "false") +
                   ",\"timestamp\":" + String(millis()) + "}";

  int httpCode = http.POST(payload);
  if (httpCode > 0) {
    Serial.println("Reported: " + String(occupied ? "OCCUPIED" : "VACANT"));
    digitalWrite(LED_PIN, occupied ? HIGH : LOW);
  }
  http.end();
}

void goToSleep() {
  Serial.println("Going to sleep for " + String(SLEEP_DURATION_SECONDS) + " seconds");
  ESP.deepSleep(SLEEP_DURATION_SECONDS * 1000000);
}
```

### Power Optimization Strategy

**Sleep Modes:**
1. **Active Mode** (occupied): 80mA average
   - WiFi active, frequent reporting
   - PIR sensor active
   - Reports every 5 seconds

2. **Deep Sleep** (vacant): 20µA average
   - Wake every 60 seconds to check PIR
   - WiFi off, CPU off
   - RTC timer wake-up

**Battery Life Calculation:**
```
Scenario: 18650 battery (3000mAh)
- 95% vacant time: 20µA × 0.95 = 19µA
- 5% occupied time: 80mA × 0.05 = 4mA
- Average current: ~4mA

Battery life = 3000mAh / 4mA = 750 hours = 31 days

With optimizations (wake every 5 minutes when vacant):
Battery life = 3-6 months
```

### Installation Guide

1. **Mounting Location:**
   - Install inside toilet stall, above door height
   - PIR sensor facing occupant area (not door)
   - Avoid direct sunlight or heat sources
   - 2-3 meters from toilet for optimal detection

2. **Configuration:**
   - Set WiFi credentials via serial or web portal
   - Assign unique device ID per sensor
   - Adjust PIR sensitivity and delay (HC-SR501 only)

3. **Testing:**
   - Power on, verify LED blinks (WiFi connecting)
   - Check registration on Pi dashboard
   - Test occupancy detection (wave hand, check Pi logs)
   - Verify battery charging circuit

## Acceptance Criteria

- [ ] **Hardware Design**: PCB layout or breadboard schematic documented
- [ ] **Component Sourcing**: Bill of materials with suppliers and costs (target £5/unit)
- [ ] **Firmware Complete**: ESP8266 code compiles and flashes successfully
- [ ] **WiFi Connection**: Sensor connects to test network reliably
- [ ] **Device Registration**: Sensor registers with Pi gateway on first boot
- [ ] **Motion Detection**: PIR sensor triggers on human presence (3-7m range)
- [ ] **Occupancy Reporting**: HTTP POST to Pi gateway when state changes
- [ ] **Deep Sleep**: Sensor enters low-power mode when vacant (confirmed <50µA)
- [ ] **Battery Life**: Measured >30 days on single 18650 charge (under normal use)
- [ ] **Charging System**: USB charging works, protection circuit prevents over-discharge
- [ ] **Enclosure Design**: 3D model or off-the-shelf box accommodates all components
- [ ] **Status LED**: Visual indication of occupied/vacant/connecting states
- [ ] **Reconnection Logic**: Sensor recovers from WiFi dropouts automatically
- [ ] **Multiple Sensors**: System supports 10+ sensors per Pi gateway
- [ ] **Configuration Portal**: Web interface for WiFi setup (optional, nice-to-have)
- [ ] **Installation Guide**: Documentation with mounting instructions and diagrams
- [ ] **Field Testing**: 72-hour continuous operation test passed
- [ ] **False Positive Rate**: <1% false detections under normal conditions
- [ ] **Response Time**: Occupancy reported to Pi within 2 seconds of detection

## Dependencies
- Story 1.3 (ESP32 baseline) - firmware development patterns
- Story 1.6 (Test lab) - testing environment
- Story 3.2 (ESP32 ↔ Pi communication) - HTTP API protocols
- Arduino IDE with ESP8266 board support installed
- Pi gateway with HTTP API endpoints (Story 2.2)

## Notes
- HC-SR501 has adjustable sensitivity potentiometers (useful for tuning)
- AM312 is smaller but less flexible (consider for tight spaces)
- Consider adding temperature/humidity sensor (DHT22) for bonus data
- 3D print files to be stored in `toilet/hardware/pir_enclosure/`
- Future enhancement: LoRa version for sites without WiFi
- Consider Zigbee/Thread for mesh networking (lower power than WiFi)
- ESP8266 can run on 2 AA batteries with buck converter (cheaper alternative)
- Test false positives from air currents, sunlight, small animals
