````markdown
# Story 1.4: Ansible Playbooks for Automated Server Provisioning

**Epic:** 1 - Infrastructure Enhancement
**Status:** ❌ TODO

## Description
Create Ansible playbooks and roles for automated provisioning, configuration, and deployment of Guard-e-loo infrastructure components including WordPress servers, Raspberry Pi gateways, and future expansion nodes. This enables infrastructure-as-code, consistent deployments, and easy scaling to multiple sites.

## Goals
- Automated EC2 instance provisioning and configuration
- Raspberry Pi gateway setup automation
- Docker and Docker Compose installation
- WordPress dual-stack deployment automation
- SSL certificate installation and renewal setup
- Database initialization and backup configuration
- Security hardening (firewall, SSH keys, fail2ban)
- Idempotent playbooks (safe to re-run)
- Multi-environment support (production, staging, development)
- Secrets management with Ansible Vault

## Technical Implementation

### Project Structure

**File: `ansible/` directory layout**
```
ansible/
├── ansible.cfg              # Ansible configuration
├── inventory/
│   ├── production.yml       # Production hosts
│   ├── staging.yml          # Staging hosts
│   ├── development.yml      # Development hosts
│   └── group_vars/
│       ├── all.yml          # Global variables
│       ├── wordpress.yml    # WordPress-specific vars
│       └── pi_gateways.yml  # Pi gateway vars
├── playbooks/
│   ├── site.yml             # Master playbook
│   ├── wordpress.yml        # WordPress server setup
│   ├── pi_gateway.yml       # Raspberry Pi gateway setup
│   ├── ssl_setup.yml        # SSL certificate automation
│   ├── backup_setup.yml     # Backup automation
│   └── security.yml         # Security hardening
├── roles/
│   ├── common/              # Base system configuration
│   ├── docker/              # Docker installation
│   ├── wordpress/           # WordPress deployment
│   ├── nginx/               # Nginx configuration
│   ├── ssl/                 # SSL/TLS management
│   ├── mysql/               # Database setup
│   ├── pi_gateway/          # Pi-specific configuration
│   └── monitoring/          # Monitoring agents
├── templates/
│   ├── docker-compose.yml.j2
│   ├── nginx.conf.j2
│   └── .env.j2
├── files/
│   ├── manage.sh
│   ├── ssl-multi-domain.sh
│   └── backup-db.sh
└── secrets/
    ├── production.vault.yml  # Encrypted secrets
    └── staging.vault.yml     # Encrypted secrets
```

### Ansible Configuration

**File: `ansible/ansible.cfg`**
```ini
[defaults]
inventory = inventory/production.yml
roles_path = roles
host_key_checking = False
retry_files_enabled = False
gathering = smart
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_facts
fact_caching_timeout = 3600

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False

[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=60s
pipelining = True
```

### Inventory Configuration

**File: `ansible/inventory/production.yml`**
```yaml
all:
  children:
    wordpress_servers:
      hosts:
        guard-e-loo-web:
          ansible_host: ec2-3-8-123-45.eu-west-2.compute.amazonaws.com
          ansible_user: ubuntu
          ansible_ssh_private_key_file: ~/.ssh/guard-e-loo.pem

    pi_gateways:
      hosts:
        pi-gateway-001:
          ansible_host: 192.168.1.100
          ansible_user: pi
          site_id: site001
          location: "Test Site Alpha"

        pi-gateway-002:
          ansible_host: 192.168.1.101
          ansible_user: pi
          site_id: site002
          location: "Test Site Beta"

  vars:
    domain: guard-e-loo.co.uk
    admin_email: admin@guard-e-loo.co.uk
    ssl_provider: letsencrypt
    backup_retention_days: 7
```

**File: `ansible/inventory/group_vars/all.yml`**
```yaml
---
# Global variables
ansible_python_interpreter: /usr/bin/python3

# Docker configuration
docker_edition: ce
docker_version: 24.0
docker_compose_version: 2.20.0

# System packages
required_packages:
  - git
  - curl
  - vim
  - htop
  - rsync
  - ufw
  - fail2ban
  - unattended-upgrades

# Timezone
timezone: Europe/London

# SSH hardening
ssh_port: 22
ssh_permit_root_login: no
ssh_password_authentication: no
ssh_pubkey_authentication: yes
```

**File: `ansible/inventory/group_vars/wordpress.yml`**
```yaml
---
# WordPress deployment configuration
wordpress_root: /home/ubuntu/toilet
wordpress_production_dir: "{{ wordpress_root }}/production"
wordpress_staging_dir: "{{ wordpress_root }}/staging"
wordpress_proxy_dir: "{{ wordpress_root }}/proxy"

# Database configuration
mysql_root_password: "{{ vault_mysql_root_password }}"
mysql_user: wordpress_user
mysql_password: "{{ vault_mysql_password }}"
mysql_database: wordpress

# WordPress domains
production_domain: www.guard-e-loo.co.uk
staging_domain: staging.guard-e-loo.co.uk
ops_domain: op.guard-e-loo.co.uk

# SSL certificates
ssl_domains:
  - guard-e-loo.co.uk
  - www.guard-e-loo.co.uk
  - staging.guard-e-loo.co.uk
  - op.guard-e-loo.co.uk
```

### Master Playbook

**File: `ansible/playbooks/site.yml`**
```yaml
---
- name: Setup Guard-e-loo Infrastructure
  hosts: all
  roles:
    - common

- name: Setup WordPress Servers
  hosts: wordpress_servers
  roles:
    - docker
    - wordpress
    - nginx
    - ssl
    - backup_setup
    - security

- name: Setup Pi Gateways
  hosts: pi_gateways
  roles:
    - common
    - docker
    - pi_gateway
    - security
```

### Common Role (Base System)

**File: `ansible/roles/common/tasks/main.yml`**
```yaml
---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required system packages
  apt:
    name: "{{ required_packages }}"
    state: present

- name: Set timezone
  timezone:
    name: "{{ timezone }}"

- name: Create Guard-e-loo user
  user:
    name: guardeloo
    shell: /bin/bash
    create_home: yes
    groups: docker,sudo
    append: yes

- name: Configure automatic security updates
  apt:
    name: unattended-upgrades
    state: present

- name: Copy unattended-upgrades config
  template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades

- name: Ensure NTP is running
  systemd:
    name: systemd-timesyncd
    state: started
    enabled: yes
```

### Docker Role

**File: `ansible/roles/docker/tasks/main.yml`**
```yaml
---
- name: Install Docker prerequisites
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present

- name: Add Docker GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present

- name: Install Docker
  apt:
    name: docker-ce
    state: present
    update_cache: yes

- name: Install Docker Compose
  get_url:
    url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-Linux-x86_64"
    dest: /usr/local/bin/docker-compose
    mode: '0755'

- name: Add users to docker group
  user:
    name: "{{ item }}"
    groups: docker
    append: yes
  loop:
    - ubuntu
    - guardeloo

- name: Enable Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Create Docker network for proxy
  docker_network:
    name: proxy-network
    state: present
```

### WordPress Role

**File: `ansible/roles/wordpress/tasks/main.yml`**
```yaml
---
- name: Clone Guard-e-loo repository
  git:
    repo: https://github.com/WeeDom/toilet.git
    dest: "{{ wordpress_root }}"
    version: main
    force: yes

- name: Create environment files from templates
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0600'
  loop:
    - { src: 'production.env.j2', dest: '{{ wordpress_production_dir }}/.env' }
    - { src: 'staging.env.j2', dest: '{{ wordpress_staging_dir }}/.env' }

- name: Create backup directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ wordpress_production_dir }}/backups"
    - "{{ wordpress_staging_dir }}/backups"

- name: Copy management scripts
  copy:
    src: "{{ item }}"
    dest: "{{ wordpress_root }}/{{ item }}"
    mode: '0755'
  loop:
    - manage.sh
    - ssl-multi-domain.sh
    - backup-db.sh

- name: Start Docker containers
  docker_compose:
    project_src: "{{ item }}"
    state: present
  loop:
    - "{{ wordpress_proxy_dir }}"
    - "{{ wordpress_production_dir }}"
    - "{{ wordpress_staging_dir }}"

- name: Wait for WordPress to be ready
  uri:
    url: "http://localhost:80"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 30
  delay: 10
```

**File: `ansible/roles/wordpress/templates/production.env.j2`**
```
MYSQL_ROOT_PASSWORD={{ vault_mysql_root_password }}
MYSQL_USER={{ mysql_user }}
MYSQL_PASSWORD={{ vault_mysql_password }}
MYSQL_DATABASE={{ mysql_database }}
WORDPRESS_DB_HOST=mysql:3306
WORDPRESS_DB_NAME={{ mysql_database }}
```

### SSL Role

**File: `ansible/roles/ssl/tasks/main.yml`**
```yaml
---
- name: Install Certbot
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present

- name: Create SSL directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/guard-e-loo-ssl
    - /opt/guard-e-loo-ssl/webroot
    - /opt/guard-e-loo-ssl/logs

- name: Copy SSL management script
  copy:
    src: ssl-multi-domain.sh
    dest: /usr/local/bin/ssl-multi-domain.sh
    mode: '0755'

- name: Initialize SSL certificates
  command: /usr/local/bin/ssl-multi-domain.sh init
  args:
    creates: /etc/letsencrypt/live/{{ domain }}/fullchain.pem

- name: Setup SSL renewal cron job
  cron:
    name: "SSL certificate renewal"
    minute: "37"
    hour: "3"
    job: "/usr/local/bin/ssl-multi-domain.sh renew >> /opt/guard-e-loo-ssl/logs/renewal.log 2>&1"
```

### Backup Role

**File: `ansible/roles/backup_setup/tasks/main.yml`**
```yaml
---
- name: Copy backup scripts
  template:
    src: backup-db.sh.j2
    dest: "{{ item }}/backup-db.sh"
    mode: '0755'
  loop:
    - "{{ wordpress_production_dir }}"
    - "{{ wordpress_staging_dir }}"

- name: Setup production backup cron job
  cron:
    name: "Production database backup"
    minute: "0"
    hour: "2"
    job: "{{ wordpress_production_dir }}/backup-db.sh"

- name: Setup staging backup cron job
  cron:
    name: "Staging database backup"
    minute: "0"
    hour: "3"
    job: "{{ wordpress_staging_dir }}/backup-db.sh"

- name: Setup backup retention cleanup
  cron:
    name: "Cleanup old backups"
    minute: "0"
    hour: "4"
    job: "find {{ wordpress_production_dir }}/backups {{ wordpress_staging_dir }}/backups -name '*.sql.gz' -mtime +{{ backup_retention_days }} -delete"
```

### Security Role

**File: `ansible/roles/security/tasks/main.yml`**
```yaml
---
- name: Configure UFW firewall
  ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
  loop:
    - { rule: 'allow', port: '22', proto: 'tcp' }
    - { rule: 'allow', port: '80', proto: 'tcp' }
    - { rule: 'allow', port: '443', proto: 'tcp' }

- name: Enable UFW
  ufw:
    state: enabled
    policy: deny

- name: Install and configure fail2ban
  apt:
    name: fail2ban
    state: present

- name: Configure fail2ban for SSH
  copy:
    content: |
      [sshd]
      enabled = true
      port = {{ ssh_port }}
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 3600
    dest: /etc/fail2ban/jail.local

- name: Restart fail2ban
  systemd:
    name: fail2ban
    state: restarted
    enabled: yes

- name: Harden SSH configuration
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
  notify: restart sshd
```

### Pi Gateway Role

**File: `ansible/roles/pi_gateway/tasks/main.yml`**
```yaml
---
- name: Install Python dependencies for Pi
  apt:
    name:
      - python3-pip
      - python3-opencv
      - python3-numpy
    state: present

- name: Clone Guard-e-loo Pi code
  git:
    repo: https://github.com/WeeDom/toilet.git
    dest: /home/pi/guard-e-loo
    version: main

- name: Install Pi Python requirements
  pip:
    requirements: /home/pi/guard-e-loo/pi1/requirements.txt
    executable: pip3

- name: Configure Pi as gateway
  template:
    src: pi_config.yml.j2
    dest: /home/pi/guard-e-loo/pi1/config.yml

- name: Create Pi gateway systemd service
  template:
    src: guard-e-loo-gateway.service.j2
    dest: /etc/systemd/system/guard-e-loo-gateway.service

- name: Enable Pi gateway service
  systemd:
    name: guard-e-loo-gateway
    state: started
    enabled: yes
    daemon_reload: yes
```

### Secrets Management

**File: `ansible/secrets/production.vault.yml` (encrypted)**
```yaml
---
vault_mysql_root_password: "super_secure_root_password_here"
vault_mysql_password: "secure_wordpress_password_here"
vault_admin_ssh_keys:
  - "ssh-rsa AAAAB3... admin@guard-e-loo"
  - "ssh-rsa AAAAB3... deploy@guard-e-loo"
```

**Encrypt secrets:**
```bash
ansible-vault encrypt ansible/secrets/production.vault.yml
# Enter vault password when prompted
```

**Edit encrypted secrets:**
```bash
ansible-vault edit ansible/secrets/production.vault.yml
```

## Usage Examples

**Initial WordPress Server Setup:**
```bash
cd ansible/
ansible-playbook playbooks/wordpress.yml \
  --inventory inventory/production.yml \
  --ask-vault-pass
```

**Setup All Pi Gateways:**
```bash
ansible-playbook playbooks/pi_gateway.yml \
  --inventory inventory/production.yml \
  --limit pi_gateways
```

**Run Full Infrastructure Setup:**
```bash
ansible-playbook playbooks/site.yml \
  --inventory inventory/production.yml \
  --ask-vault-pass
```

**Check Mode (Dry Run):**
```bash
ansible-playbook playbooks/site.yml \
  --inventory inventory/production.yml \
  --check \
  --diff
```

**Run Security Hardening Only:**
```bash
ansible-playbook playbooks/security.yml \
  --inventory inventory/production.yml
```

## Acceptance Criteria

- [ ] **Ansible Installed**: Ansible 2.14+ on control machine
- [ ] **Inventory Files**: Production, staging, dev inventories complete
- [ ] **Master Playbook**: site.yml orchestrates all roles
- [ ] **Common Role**: Base system configuration (packages, timezone, users)
- [ ] **Docker Role**: Docker and Docker Compose installation
- [ ] **WordPress Role**: Dual-stack deployment automation
- [ ] **SSL Role**: Certificate generation and renewal setup
- [ ] **Backup Role**: Automated database backups configured
- [ ] **Security Role**: UFW, fail2ban, SSH hardening
- [ ] **Pi Gateway Role**: Raspberry Pi gateway setup
- [ ] **Secrets Encrypted**: Ansible Vault protects sensitive data
- [ ] **Idempotent**: Playbooks safe to re-run without errors
- [ ] **Documentation**: README with usage examples
- [ ] **Testing**: Playbooks tested on fresh Ubuntu 22.04 instance
- [ ] **Multi-Environment**: Supports production, staging, development
- [ ] **Error Handling**: Proper task failure handling and rollback

## Dependencies
- Ansible 2.14+ on control machine
- Story 1.1 (Docker dual-stack) - deployment target
- Story 1.2 (Management scripts) - scripts to deploy
- SSH access to target servers
- Python 3 on target servers

## Notes

- Ansible control machine can be developer laptop or CI/CD server
- Use `--check` mode to preview changes before applying
- Vault password should be stored securely (e.g., password manager)
- Consider using `ansible-vault encrypt_string` for inline secrets
- Tags can be added to roles for selective execution
- Handlers (like "restart sshd") should be in `roles/*/handlers/main.yml`
- Use `ansible-galaxy` to install third-party roles if needed
- Test playbooks on disposable VMs before production runs
- Keep inventory files outside git (add to `.gitignore`)
- Consider using Ansible Tower/AWX for web UI and RBAC

````
